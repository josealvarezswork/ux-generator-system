<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f5f5f4;
      --bg-grid: #e8e8e6;
      --panel: #ffffff;
      --card: #ffffff;
      --card-alt: #fafaf9;
      --inset: #f5f5f4;
      --text: #1c1917;
      --text-muted: #78716c;
      --text-faint: #a8a29e;
      --line: #e7e5e4;
      --line-strong: #d6d3d1;
      --accent: #2563eb;
      --accent-soft: rgba(37,99,235,.08);
      --accent-border: rgba(37,99,235,.25);
      --success: #16a34a;
      --success-soft: rgba(22,163,74,.1);
      --warning: #d97706;
      --error: #dc2626;
      --card-yellow: #fef9c3;
      --card-blue: #dbeafe;
      --card-green: #dcfce7;
      --card-orange: #ffedd5;
      --radius: 16px;
      --radius-sm: 12px;
      --radius-lg: 20px;
      --shadow: 0 4px 12px rgba(0,0,0,.08);
      --font-ui: 'Inter', system-ui, sans-serif;
      --font-mono: 'DM Mono', monospace;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      background-image: linear-gradient(var(--bg-grid) 1px, transparent 1px), linear-gradient(90deg, var(--bg-grid) 1px, transparent 1px);
      background-size: 24px 24px;
      color: var(--text);
      font-family: var(--font-ui);
      font-size: 12px;
      line-height: 1.5;
      padding: 14px;
      min-height: 100vh;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--line);
    }

    .header h1 {
      font-size: 15px;
      font-weight: 800;
      letter-spacing: -0.5px;
      color: var(--text);
    }

    /* Mode Selector */
    .mode-selector {
      display: flex;
      gap: 4px;
      padding: 5px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      margin-bottom: 14px;
      box-shadow: var(--shadow);
    }

    .mode-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 9px 14px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-muted);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      font-family: var(--font-ui);
      transition: all .15s;
    }

    .mode-btn:hover { background: var(--card-alt); color: var(--text); }
    .mode-btn.active { background: var(--accent-soft); border-color: var(--accent-border); color: var(--accent); }

    /* Phase Navigation */
    .phase-nav {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      overflow: hidden;
      margin-bottom: 14px;
      box-shadow: var(--shadow);
    }

    .phase-progress-bar {
      height: 4px;
      background: var(--line);
      position: relative;
    }

    .phase-progress-bar::after {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: var(--progress, 0%);
      background: linear-gradient(90deg, #ca8a04, #16a34a, #ea580c, #2563eb);
      transition: width 0.3s ease;
    }

    .phase-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
    }

    .current-phase {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .phase-icon {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 10px;
      flex-shrink: 0;
    }

    .phase-icon.yellow { background: var(--card-yellow); color: #ca8a04; }
    .phase-icon.green { background: var(--card-green); color: #16a34a; }
    .phase-icon.orange { background: var(--card-orange); color: #ea580c; }
    .phase-icon.blue { background: var(--card-blue); color: #2563eb; }
    .phase-icon.gradient { background: linear-gradient(135deg, var(--card-green), var(--card-blue)); color: var(--success); }

    .phase-label {
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
    }

    .phase-count {
      font-size: 10px;
      font-weight: 600;
      font-family: var(--font-mono);
      color: var(--text-faint);
      background: var(--bg);
      padding: 3px 7px;
      border-radius: 6px;
    }

    .phase-count.complete { background: var(--success-soft); color: var(--success); }

    .stage-indicator {
      font-size: 11px;
      font-weight: 600;
      font-family: var(--font-mono);
      color: var(--text-muted);
      background: var(--card-alt);
      padding: 5px 10px;
      border-radius: 6px;
      border: 1px solid var(--line);
    }

    /* Form Panel */
    .form-panel {
      background: var(--panel);
      border: 2px solid #facc15;
      border-radius: var(--radius-lg);
      box-shadow: 0 4px 20px rgba(250,204,21,0.15);
      overflow: hidden;
      display: none;
    }

    .form-panel.active { display: block; }

    .panel-inner {
      padding: 14px;
    }

    /* Card */
    .card {
      background: var(--card-alt);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
    }

    .card-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .card h2 {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
    }

    .req {
      color: #ca8a04;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      border: 1px solid rgba(250,204,21,0.4);
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--card-yellow);
    }

    /* Fields */
    .field { margin-top: 12px; }
    .field:first-child { margin-top: 0; }

    label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--text);
    }

    .input, textarea, select {
      width: 100%;
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      padding: 9px 11px;
      font-size: 12px;
      font-family: var(--font-ui);
      outline: none;
      transition: border-color .15s, box-shadow .15s;
    }

    textarea { min-height: 65px; resize: vertical; }

    .input::placeholder, textarea::placeholder { color: var(--text-faint); }

    .input:focus, textarea:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%2378716c' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 28px;
      cursor: pointer;
    }

    /* Checkbox grid */
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 5px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 7px 9px;
      border-radius: var(--radius-sm);
      background: var(--panel);
      border: 1px solid var(--line);
      cursor: pointer;
      font-size: 10px;
      user-select: none;
      transition: all .15s;
    }

    .checkbox-item:hover { border-color: var(--line-strong); background: var(--card-alt); }
    .checkbox-item:has(input:checked) { background: var(--accent-soft); border-color: var(--accent-border); }
    .checkbox-item input[type="checkbox"] { width: auto; margin: 0; cursor: pointer; accent-color: var(--accent); }
    .checkbox-item span { color: var(--text-muted); }
    .checkbox-item input:checked + span { color: var(--accent); font-weight: 600; }

    /* Radio list */
    .radio-list { display: grid; gap: 5px; margin-top: 6px; }

    .radio {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: var(--radius-sm);
      background: var(--panel);
      border: 1px solid var(--line);
      cursor: pointer;
      user-select: none;
      transition: all .15s;
    }

    .radio:hover { border-color: var(--line-strong); }
    .radio:has(input:checked) { background: var(--accent-soft); border-color: var(--accent-border); }
    .radio input { cursor: pointer; accent-color: var(--accent); }
    .radio span { color: var(--text-muted); font-size: 11px; }
    .radio input:checked + span { color: var(--accent); font-weight: 600; }

    /* Buttons */
    .btn {
      border: 0;
      border-radius: var(--radius-sm);
      padding: 9px 16px;
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
      color: #fff;
      background: var(--text);
      transition: all .15s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-family: var(--font-ui);
    }

    .btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.15); }
    .btn:disabled { opacity: .4; cursor: not-allowed; transform: none !important; }

    .btn.secondary {
      color: var(--text);
      background: var(--panel);
      border: 1px solid var(--line);
    }

    .btn.secondary:hover:not(:disabled) { background: var(--card-alt); border-color: var(--line-strong); }

    .btn.success { background: var(--success); }
    .btn.success:hover:not(:disabled) { background: #15803d; }

    .btn svg { width: 13px; height: 13px; }

    /* Section nav */
    .section-nav {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px solid var(--line);
    }

    .section-nav .btn { flex: 1; }

    /* Actions */
    .actions {
      display: flex;
      gap: 8px;
      margin-top: 14px;
      flex-wrap: wrap;
    }

    .actions .btn { flex: 1; justify-content: center; }

    /* Theme selector */
    .theme-selector {
      display: flex;
      gap: 5px;
      margin-top: 10px;
    }

    .theme-option {
      flex: 1;
      padding: 9px;
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      background: var(--panel);
      cursor: pointer;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      font-family: var(--font-ui);
      transition: all .15s;
    }

    .theme-option:hover { border-color: var(--line-strong); background: var(--card-alt); }
    .theme-option.active { border-color: var(--accent); background: var(--accent-soft); color: var(--accent); }

    /* Status */
    .status {
      margin-top: 12px;
      padding: 10px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      text-align: center;
      font-weight: 500;
    }

    .status.loading { background: var(--accent-soft); color: var(--accent); border: 1px solid var(--accent-border); }
    .status.success { background: var(--success-soft); color: var(--success); border: 1px solid rgba(22,163,74,.25); }
    .status.error { background: rgba(220,38,38,.08); color: var(--error); border: 1px solid rgba(220,38,38,.25); }

    /* Paste Panel */
    .paste-panel {
      background: var(--panel);
      border: 2px solid var(--accent);
      border-radius: var(--radius-lg);
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: 0 4px 20px rgba(37,99,235,0.1);
      display: none;
    }

    .paste-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .paste-info p {
      font-size: 11px;
      color: var(--text-muted);
    }

    .webapp-link {
      font-size: 10px;
      color: var(--accent);
      text-decoration: none;
      padding: 5px 10px;
      background: var(--accent-soft);
      border: 1px solid var(--accent-border);
      border-radius: 6px;
      font-weight: 600;
    }

    .webapp-link:hover { background: rgba(37,99,235,.12); }

    .json-textarea {
      width: 100%;
      min-height: 120px;
      background: var(--card-alt);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      padding: 10px;
      font-size: 10px;
      font-family: var(--font-mono);
      resize: vertical;
    }

    .json-textarea::placeholder { color: var(--text-faint); }

    .json-textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
      outline: none;
    }

    .paste-actions {
      margin-top: 14px;
    }

    /* Generate Panel */
    .generate-panel {
      background: var(--panel);
      border: 2px solid var(--success);
      border-radius: var(--radius-lg);
      box-shadow: 0 4px 20px rgba(22,163,74,0.15);
      text-align: center;
      padding: 20px 14px;
      display: none;
    }

    .generate-panel.active { display: block; }

    .generate-icon {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--card-green), var(--card-blue));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin: 0 auto 14px;
    }

    .generate-panel h3 {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .generate-panel > p {
      color: var(--text-muted);
      font-size: 11px;
      margin-bottom: 16px;
    }

    /* Utilities */
    .sub { color: var(--text-faint); font-size: 10px; margin-top: 4px; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="header">
    <h1>UX AI Generator</h1>
  </div>

  <!-- Mode Selector -->
  <div class="mode-selector" id="modeSelector">
    <button type="button" class="mode-btn active" data-mode="form">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
      </svg>
      Generate here
    </button>
    <button type="button" class="mode-btn" data-mode="paste">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="9" y="9" width="13" height="13" rx="2"/>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
      </svg>
      Paste JSON
    </button>
  </div>

  <!-- Paste JSON Panel -->
  <div class="paste-panel" id="pastePanel">
    <div class="paste-info">
      <p>Paste JSON from the webapp:</p>
      <a href="https://josealvarezswork.github.io/uxgenerative/" target="_blank" class="webapp-link">Open webapp</a>
    </div>
    <textarea id="jsonInput" class="json-textarea" placeholder='{"project_overview": {...}, "user_persona": {...}, ...}'></textarea>
    <div class="paste-actions">
      <div class="field" style="margin: 0;">
        <label style="margin-bottom: 4px;">Theme</label>
        <div class="theme-selector" style="margin: 0;">
          <button type="button" class="theme-option active" data-theme="dark">Dark</button>
          <button type="button" class="theme-option" data-theme="light">Light</button>
          <button type="button" class="theme-option" data-theme="notion">Notion</button>
        </div>
      </div>
      <div class="field" style="margin: 8px 0 0 0;">
        <label style="margin-bottom: 4px;">Layout</label>
        <div class="theme-selector layout-selector" style="margin: 0;">
          <button type="button" class="theme-option layout-option active" data-layout="vertical">Vertical</button>
          <button type="button" class="theme-option layout-option" data-layout="horizontal">Horizontal</button>
          <button type="button" class="theme-option layout-option" data-layout="separate">Separate</button>
        </div>
      </div>
      <button type="button" class="btn success" id="generateFromJson" style="margin-top: 12px; width: 100%;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        Generate in Figma
      </button>
    </div>
    <div id="pasteStatusArea"></div>
  </div>

  <!-- Phase Navigation -->
  <nav class="phase-nav" id="phaseNav">
    <div class="phase-progress-bar" id="phaseProgressBar"></div>
    <div class="phase-header">
      <div class="current-phase" id="currentPhaseDisplay">
        <span class="phase-icon yellow" id="currentPhaseIcon">D</span>
        <span class="phase-label" id="currentPhaseLabel">Definition</span>
        <span class="phase-count" id="currentPhaseCount">0/3</span>
      </div>
      <div class="stage-indicator" id="stageIndicator">Stage 1/4</div>
    </div>
  </nav>

  <form id="uxForm" novalidate>

    <!-- 1. PROJECT IDENTITY -->
    <div class="form-panel active" data-section="1">
      <div class="panel-inner">
        <div class="card">
          <div class="card-title">
            <h2>1. Project Identity</h2>
            <span class="req">Required</span>
          </div>

          <div class="field">
            <label for="projectName">Project Name</label>
            <input class="input" id="projectName" name="projectName" required placeholder="Good Manual" />
          </div>

          <div class="field">
            <label for="oneSentence">One-sentence Description</label>
            <input class="input" id="oneSentence" name="oneSentence" maxlength="200" required placeholder="App movil para..." />
          </div>

          <div class="field">
            <label for="productType">Product Type</label>
            <select id="productType" name="productType" required>
              <option value="" selected disabled>Select...</option>
              <option value="App">App</option>
              <option value="Platform">Platform</option>
              <option value="Service">Service</option>
              <option value="Tool">Tool</option>
              <option value="Hardware">Hardware</option>
              <option value="Hybrid">Hybrid</option>
            </select>
          </div>

          <div class="field">
            <label>Primary Platform(s)</label>
            <div class="checkbox-grid">
              <label class="checkbox-item"><input type="checkbox" name="primaryPlatforms" value="Mobile" /><span>Mobile</span></label>
              <label class="checkbox-item"><input type="checkbox" name="primaryPlatforms" value="Web" /><span>Web</span></label>
              <label class="checkbox-item"><input type="checkbox" name="primaryPlatforms" value="Desktop" /><span>Desktop</span></label>
              <label class="checkbox-item"><input type="checkbox" name="primaryPlatforms" value="Tablet" /><span>Tablet</span></label>
              <label class="checkbox-item"><input type="checkbox" name="primaryPlatforms" value="Physical" /><span>Physical</span></label>
              <label class="checkbox-item"><input type="checkbox" name="primaryPlatforms" value="Hybrid" /><span>Hybrid</span></label>
            </div>
          </div>

          <div class="section-nav">
            <button type="button" class="btn secondary" data-nav="prev" disabled>Previous</button>
            <button type="button" class="btn" data-nav="next">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. PROBLEM & CONTEXT -->
    <div class="form-panel" data-section="2">
      <div class="panel-inner">
        <div class="card">
          <div class="card-title">
            <h2>2. Problem & Context</h2>
            <span class="req">Required</span>
          </div>

          <div class="field">
            <label for="realWorldSituation">Real-world situation</label>
            <textarea id="realWorldSituation" name="realWorldSituation" required placeholder="What is happening today? Who experiences it?"></textarea>
          </div>

          <div class="field">
            <label for="whatGoesWrong">What goes wrong?</label>
            <textarea id="whatGoesWrong" name="whatGoesWrong" required placeholder="What fails and what are the consequences?"></textarea>
          </div>

          <div class="field">
            <label for="currentWorkarounds">Current workarounds</label>
            <textarea id="currentWorkarounds" name="currentWorkarounds" required placeholder="What do they do today? What tools do they use?"></textarea>
          </div>

          <div class="section-nav">
            <button type="button" class="btn secondary" data-nav="prev">Previous</button>
            <button type="button" class="btn" data-nav="next">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 3. USER EVIDENCE -->
    <div class="form-panel" data-section="3">
      <div class="panel-inner">
        <div class="card">
          <div class="card-title">
            <h2>3. User Evidence</h2>
            <span class="req">Required</span>
          </div>

          <div class="field">
            <label for="userRoleContext">User role & context</label>
            <input class="input" id="userRoleContext" name="userRoleContext" required placeholder='E.g: "Aeronautical technicians in hangar..."' />
          </div>

          <div class="field">
            <label for="tryingToAccomplish">What they're trying to accomplish</label>
            <textarea id="tryingToAccomplish" name="tryingToAccomplish" required placeholder="Goal + why it matters"></textarea>
          </div>

          <div class="field">
            <label>Research backing</label>
            <div class="radio-list">
              <label class="radio"><input type="checkbox" name="researchBacking" value="User interviews" /><span>User interviews</span></label>
              <label class="radio"><input type="checkbox" name="researchBacking" value="Surveys/Analytics" /><span>Surveys/Analytics</span></label>
              <label class="radio"><input type="checkbox" name="researchBacking" value="Observation/Desk research" /><span>Observation/Desk</span></label>
              <label class="radio"><input type="checkbox" name="researchBacking" value="No research yet" /><span>No research yet</span></label>
            </div>
          </div>

          <div class="field">
            <label for="researchBackingDetails">Research Details</label>
            <textarea id="researchBackingDetails" name="researchBackingDetails" required placeholder="Key findings or quotes"></textarea>
          </div>

          <div class="section-nav">
            <button type="button" class="btn secondary" data-nav="prev">Previous</button>
            <button type="button" class="btn" data-nav="next">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 4. VALUE HYPOTHESIS -->
    <div class="form-panel" data-section="4">
      <div class="panel-inner">
        <div class="card">
          <div class="card-title">
            <h2>4. Value Hypothesis</h2>
            <span class="req">Required</span>
          </div>

          <div class="field">
            <label for="desiredOutcome">Desired outcome</label>
            <textarea id="desiredOutcome" name="desiredOutcome" required placeholder="How would it be better? How would the user know it worked?"></textarea>
          </div>

          <div class="field">
            <label for="whyUseThis">Why they'd use this</label>
            <textarea id="whyUseThis" name="whyUseThis" required placeholder="Core value prop + expected behavior change"></textarea>
          </div>

          <div class="field">
            <label for="productGoals">Product Goals (2-3 bullets)</label>
            <textarea id="productGoals" name="productGoals" required placeholder="- Reduce time from X to Y&#10;- Increase visibility of Z"></textarea>
          </div>

          <div class="section-nav">
            <button type="button" class="btn secondary" data-nav="prev">Previous</button>
            <button type="button" class="btn" data-nav="next">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 5. SCOPE -->
    <div class="form-panel" data-section="5">
      <div class="panel-inner">
        <div class="card">
          <div class="card-title">
            <h2>5. Scope</h2>
            <span class="req">Required</span>
          </div>

          <div class="field">
            <label for="mustHaveFeatures">Must-Have Features (3-5)</label>
            <textarea id="mustHaveFeatures" name="mustHaveFeatures" required placeholder="- ..."></textarea>
          </div>

          <div class="field">
            <label for="niceToHave">Nice-to-Have (optional)</label>
            <textarea id="niceToHave" name="niceToHave" placeholder="- ..."></textarea>
          </div>

          <div class="field">
            <label for="outOfScope">Out of Scope (optional)</label>
            <textarea id="outOfScope" name="outOfScope" placeholder="- ..."></textarea>
          </div>

          <div class="section-nav">
            <button type="button" class="btn secondary" data-nav="prev">Previous</button>
            <button type="button" class="btn" data-nav="next">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 6. CONSTRAINTS -->
    <div class="form-panel" data-section="6">
      <div class="panel-inner">
        <div class="card">
          <div class="card-title">
            <h2>6. Constraints</h2>
            <span class="req">Required</span>
          </div>

          <div class="field">
            <label for="technicalPlatformConstraints">Technical & Platform</label>
            <textarea id="technicalPlatformConstraints" name="technicalPlatformConstraints" required placeholder="Technical limitations, devices, APIs"></textarea>
          </div>

          <div class="field">
            <label for="businessTimelineConstraints">Business & Timeline</label>
            <textarea id="businessTimelineConstraints" name="businessTimelineConstraints" required placeholder="Budget, team, deadlines"></textarea>
          </div>

          <div class="field">
            <label for="adoptionRisks">Adoption Risks</label>
            <textarea id="adoptionRisks" name="adoptionRisks" required placeholder="Barriers, competition, resistance"></textarea>
          </div>

          <div class="section-nav">
            <button type="button" class="btn secondary" data-nav="prev">Previous</button>
            <button type="button" class="btn" data-nav="next">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 7. SUCCESS METRICS -->
    <div class="form-panel" data-section="7">
      <div class="panel-inner">
        <div class="card">
          <div class="card-title">
            <h2>7. Success Metrics</h2>
            <span class="req">Required</span>
          </div>

          <div class="field">
            <label for="keyMetrics">Key Metrics (2-4)</label>
            <textarea id="keyMetrics" name="keyMetrics" required placeholder="Task completion: 45% -> 80%&#10;Weekly retention: Target 60%"></textarea>
          </div>

          <div class="section-nav">
            <button type="button" class="btn secondary" data-nav="prev">Previous</button>
            <button type="button" class="btn" data-nav="next">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 8. ASSUMPTIONS CHECK -->
    <div class="form-panel" data-section="8">
      <div class="panel-inner">
        <div class="card">
          <div class="card-title">
            <h2>8. Assumptions Check</h2>
            <span class="req">Required</span>
          </div>

          <div class="field">
            <label for="facts">What you KNOW (facts)</label>
            <textarea id="facts" name="facts" required placeholder="Confirmed facts + source"></textarea>
          </div>

          <div class="field">
            <label for="assumptions">What you ASSUME</label>
            <textarea id="assumptions" name="assumptions" required placeholder="Key hypotheses"></textarea>
          </div>

          <div class="field">
            <label for="needsValidation">What needs validation</label>
            <input class="input" id="needsValidation" name="needsValidation" required placeholder="What to validate before/after" />
          </div>

          <div class="section-nav">
            <button type="button" class="btn secondary" data-nav="prev">Previous</button>
            <button type="button" class="btn" data-nav="next">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 9. PERSONA ESSENTIALS -->
    <div class="form-panel" data-section="9">
      <div class="panel-inner">
        <div class="card">
          <div class="card-title">
            <h2>9. Persona Essentials</h2>
            <span class="req">Required</span>
          </div>

          <div class="field">
            <label for="ageOccupation">Age range & Occupation</label>
            <input class="input" id="ageOccupation" name="ageOccupation" required placeholder="25-35, Maintenance technician..." />
          </div>

          <div class="field">
            <label for="techProficiency">Tech proficiency</label>
            <select id="techProficiency" name="techProficiency" required>
              <option value="" selected disabled>Select...</option>
              <option value="Savvy">Savvy</option>
              <option value="Comfortable">Comfortable</option>
              <option value="Basic">Basic</option>
            </select>
          </div>

          <div class="field">
            <label for="mainMotivations">Main motivations</label>
            <input class="input" id="mainMotivations" name="mainMotivations" required placeholder="Security, speed, precision..." />
          </div>

          <div class="field">
            <label for="dailyRoutineSnapshot">Daily routine snapshot</label>
            <textarea id="dailyRoutineSnapshot" name="dailyRoutineSnapshot" required placeholder="What does a typical day look like?"></textarea>
          </div>

          <div class="section-nav">
            <button type="button" class="btn secondary" data-nav="prev">Previous</button>
            <button type="button" class="btn" data-nav="next">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 10. JOURNEY STAGES -->
    <div class="form-panel" data-section="10">
      <div class="panel-inner">
        <div class="card">
          <div class="card-title">
            <h2>10. Journey Stages</h2>
            <span class="req">Required</span>
          </div>

          <div class="field">
            <label for="numStages">Number of stages (3-5)</label>
            <input class="input" type="number" id="numStages" name="numStages" min="3" max="5" value="3" required />
          </div>

          <div id="stagesContainer"></div>

          <div class="field">
            <label for="opportunityAreas">Opportunity areas</label>
            <textarea id="opportunityAreas" name="opportunityAreas" required placeholder="Where can we improve the experience?"></textarea>
          </div>

          <div class="section-nav">
            <button type="button" class="btn secondary" data-nav="prev">Previous</button>
            <button type="button" class="btn" data-nav="next">Generate</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 11. GENERATE -->
    <div class="generate-panel" data-section="11">
      <div class="generate-icon">G</div>
      <h3>Ready to Generate</h3>
      <p>All sections complete. Generate your UX brief in Figma.</p>

      <div class="field" style="text-align: left;">
        <label>Theme</label>
        <div class="theme-selector">
          <button type="button" class="theme-option active" data-theme="dark">Dark</button>
          <button type="button" class="theme-option" data-theme="light">Light</button>
          <button type="button" class="theme-option" data-theme="notion">Notion</button>
        </div>
      </div>

      <div class="field" style="text-align: left;">
        <label>Layout</label>
        <div class="theme-selector layout-selector">
          <button type="button" class="theme-option layout-option active" data-layout="vertical">Vertical</button>
          <button type="button" class="theme-option layout-option" data-layout="horizontal">Horizontal</button>
          <button type="button" class="theme-option layout-option" data-layout="separate">Separate</button>
        </div>
      </div>

      <div class="actions">
        <button class="btn success" type="submit" id="submitBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
          </svg>
          Generate in Figma
        </button>
      </div>

      <div id="statusArea"></div>

      <div class="section-nav" style="border: 0; padding-top: 14px;">
        <button type="button" class="btn secondary" data-nav="prev">Previous</button>
      </div>
    </div>

  </form>

  <script>
    // =======================
    // Configuration
    // =======================
    const API_URL = 'https://broad-shadow-d8e2.josealvarezswork.workers.dev/api/generate';
    let selectedTheme = 'dark';
    let selectedLayout = 'vertical';
    let currentSection = 1;
    let currentMode = 'form';
    const totalSections = 10;

    // =======================
    // Mode Switching
    // =======================
    const modeSelector = document.getElementById('modeSelector');
    const pastePanel = document.getElementById('pastePanel');
    const phaseNav = document.getElementById('phaseNav');
    const formElement = document.getElementById('uxForm');

    modeSelector.addEventListener('click', (e) => {
      const btn = e.target.closest('.mode-btn');
      if (!btn) return;

      const mode = btn.dataset.mode;
      currentMode = mode;

      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      if (mode === 'paste') {
        pastePanel.style.display = 'block';
        phaseNav.style.display = 'none';
        formElement.style.display = 'none';
      } else {
        pastePanel.style.display = 'none';
        phaseNav.style.display = 'block';
        formElement.style.display = 'block';
      }
    });

    // =======================
    // Generate from Pasted JSON
    // =======================
    const jsonInput = document.getElementById('jsonInput');
    const generateFromJsonBtn = document.getElementById('generateFromJson');
    const pasteStatusArea = document.getElementById('pasteStatusArea');

    document.querySelectorAll('.paste-panel .theme-option:not(.layout-option)').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.paste-panel .theme-option:not(.layout-option)').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedTheme = btn.dataset.theme;
      });
    });

    document.querySelectorAll('.paste-panel .layout-option').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.paste-panel .layout-option').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedLayout = btn.dataset.layout;
      });
    });

    generateFromJsonBtn.addEventListener('click', () => {
      const jsonText = jsonInput.value.trim();

      if (!jsonText) {
        pasteStatusArea.innerHTML = '<div class="status error">Paste the JSON first</div>';
        return;
      }

      try {
        const data = JSON.parse(jsonText);

        pasteStatusArea.innerHTML = '<div class="status loading">Creating frames...</div>';
        generateFromJsonBtn.disabled = true;

        parent.postMessage({
          pluginMessage: {
            type: 'generate',
            data: data,
            options: { theme: selectedTheme, layout: selectedLayout }
          }
        }, '*');

      } catch (err) {
        pasteStatusArea.innerHTML = '<div class="status error">Invalid JSON: ' + err.message + '</div>';
      }
    });

    // =======================
    // DOM Elements
    // =======================
    const form = document.getElementById('uxForm');
    const statusArea = document.getElementById('statusArea');
    const stagesContainer = document.getElementById('stagesContainer');
    const numStagesInput = document.getElementById('numStages');

    // =======================
    // Phase Configuration
    // =======================
    const phases = {
      definition: { sections: [1, 2, 3], total: 3, label: 'Definition', icon: 'D', color: 'yellow', index: 1 },
      strategy: { sections: [4, 5, 6], total: 3, label: 'Strategy', icon: 'S', color: 'green', index: 2 },
      validation: { sections: [7, 8], total: 2, label: 'Validation', icon: 'V', color: 'orange', index: 3 },
      user: { sections: [9, 10], total: 2, label: 'User', icon: 'U', color: 'blue', index: 4 },
      generate: { sections: [11], total: 0, label: 'Generate', icon: 'G', color: 'gradient', index: 5 }
    };

    const phaseOrder = ['definition', 'strategy', 'validation', 'user', 'generate'];

    function getPhaseForSection(section) {
      for (const [phase, config] of Object.entries(phases)) {
        if (config.sections.includes(section)) return phase;
      }
      return null;
    }

    function updatePhaseDisplay(phaseName) {
      const phase = phases[phaseName];
      const iconEl = document.getElementById('currentPhaseIcon');
      const labelEl = document.getElementById('currentPhaseLabel');
      const countEl = document.getElementById('currentPhaseCount');
      const stageEl = document.getElementById('stageIndicator');

      // Update icon
      iconEl.textContent = phase.icon;
      iconEl.className = 'phase-icon ' + phase.color;

      // Update label
      labelEl.textContent = phase.label;

      // Update count (hide for generate)
      if (phaseName === 'generate') {
        countEl.style.display = 'none';
        stageEl.textContent = 'Ready!';
      } else {
        countEl.style.display = 'inline';
        stageEl.textContent = `Stage ${phase.index}/4`;
      }

      // Update progress bar
      const progressBar = document.getElementById('phaseProgressBar');
      const progressPercent = ((phase.index - 1) / 4) * 100;
      progressBar.style.setProperty('--progress', progressPercent + '%');
    }

    // =======================
    // Tab Navigation
    // =======================
    function switchTab(section) {
      if (section < 1 || section > 11) return;

      currentSection = section;
      const currentPhaseName = getPhaseForSection(section);

      document.querySelectorAll('.form-panel[data-section], .generate-panel[data-section]').forEach(panel => {
        panel.classList.toggle('active', parseInt(panel.dataset.section) === section);
      });

      updatePhaseDisplay(currentPhaseName);
      updateProgress();

      document.querySelectorAll('[data-nav="prev"]').forEach(btn => {
        btn.disabled = section === 1;
      });
    }

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-nav]');
      if (!btn) return;

      e.preventDefault();
      const direction = btn.dataset.nav;

      if (direction === 'next') {
        switchTab(currentSection + 1);
      } else if (direction === 'prev') {
        switchTab(currentSection - 1);
      }
    });

    // =======================
    // Theme Selection
    // =======================
    document.querySelectorAll('#uxForm .theme-option:not(.layout-option)').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#uxForm .theme-option:not(.layout-option)').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedTheme = btn.dataset.theme;
      });
    });

    // =======================
    // Layout Selection
    // =======================
    document.querySelectorAll('#uxForm .layout-option').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#uxForm .layout-option').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedLayout = btn.dataset.layout;
      });
    });

    // =======================
    // Dynamic Stages
    // =======================
    function renderStages() {
      const num = parseInt(numStagesInput.value) || 3;
      stagesContainer.innerHTML = '';

      for (let i = 1; i <= num; i++) {
        const stageHtml = `
          <div class="field">
            <label>Stage ${i}: Name & Action</label>
            <input class="input" name="stage${i}Name" placeholder="Stage name (e.g., Discovery)" />
            <textarea name="stage${i}Action" placeholder="What does the user do?" style="margin-top:4px"></textarea>
          </div>
        `;
        stagesContainer.insertAdjacentHTML('beforeend', stageHtml);
      }
    }

    numStagesInput.addEventListener('change', renderStages);
    renderStages();

    // =======================
    // Progress Tracking
    // =======================
    function isSectionComplete(sectionNum) {
      const panel = document.querySelector(`.form-panel[data-section="${sectionNum}"]`);
      if (!panel) return false;

      const requiredInputs = panel.querySelectorAll('[required]');
      if (requiredInputs.length === 0) return false;

      return Array.from(requiredInputs).every(input => {
        if (input.type === 'checkbox') {
          const checkboxes = panel.querySelectorAll(`[name="${input.name}"]`);
          return Array.from(checkboxes).some(cb => cb.checked);
        }
        return input.value.trim() !== '';
      });
    }

    function updateProgress() {
      let totalCompleted = 0;
      const phaseProgress = {};

      // Calculate progress for each phase
      for (const [phaseName, config] of Object.entries(phases)) {
        if (phaseName === 'generate') continue;

        let phaseCompleted = 0;
        config.sections.forEach(sectionNum => {
          if (isSectionComplete(sectionNum)) {
            phaseCompleted++;
            totalCompleted++;
          }
        });

        phaseProgress[phaseName] = phaseCompleted;
      }

      // Update current phase count display
      const currentPhaseName = getPhaseForSection(currentSection);
      const countEl = document.getElementById('currentPhaseCount');
      if (currentPhaseName && currentPhaseName !== 'generate') {
        const phase = phases[currentPhaseName];
        const completed = phaseProgress[currentPhaseName] || 0;
        countEl.textContent = `${completed}/${phase.total}`;
        countEl.classList.toggle('complete', completed === phase.total);
      }

      // Update progress bar based on total completion
      const progressBar = document.getElementById('phaseProgressBar');
      const progressPercent = (totalCompleted / totalSections) * 100;
      progressBar.style.setProperty('--progress', progressPercent + '%');
    }

    form.addEventListener('input', updateProgress);
    form.addEventListener('change', updateProgress);

    // =======================
    // Status Display
    // =======================
    function showStatus(message, type = 'loading') {
      statusArea.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function clearStatus() {
      statusArea.innerHTML = '';
    }

    // =======================
    // Form Submission
    // =======================
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      showStatus('Generating UX Brief with AI...', 'loading');

      try {
        const formData = new FormData(form);
        const briefData = {};

        for (const [key, value] of formData.entries()) {
          if (key === 'primaryPlatforms' || key === 'researchBacking') {
            if (!briefData[key]) briefData[key] = [];
            briefData[key].push(value);
          } else {
            briefData[key] = value;
          }
        }

        const numStages = parseInt(briefData.numStages) || 3;
        briefData.stages = [];
        for (let i = 1; i <= numStages; i++) {
          briefData.stages.push({
            name: briefData[`stage${i}Name`] || `Stage ${i}`,
            action: briefData[`stage${i}Action`] || ''
          });
          delete briefData[`stage${i}Name`];
          delete briefData[`stage${i}Action`];
        }

        console.log('Sending to API:', briefData);

        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(briefData)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`API Error: ${response.status} - ${errorText}`);
        }

        const apiResponse = await response.json();
        console.log('API Response:', apiResponse);

        let parsedData;
        try {
          let jsonString = apiResponse.result || '{}';
          jsonString = jsonString.replace(/^```json\s*/i, '').replace(/\s*```$/i, '').trim();
          parsedData = JSON.parse(jsonString);
          if (!parsedData.projectName) {
            parsedData.projectName = briefData.projectName || 'UX Strategy Brief';
          }
        } catch (parseErr) {
          console.error('JSON parse error:', parseErr);
          throw new Error('Error parsing AI response');
        }

        console.log('Parsed data:', parsedData);
        showStatus('Creating frames in Figma...', 'loading');

        parent.postMessage({
          pluginMessage: {
            type: 'generate',
            data: parsedData,
            options: { theme: selectedTheme, layout: selectedLayout }
          }
        }, '*');

      } catch (error) {
        console.error('Error:', error);
        showStatus(`Error: ${error.message}`, 'error');
        submitBtn.disabled = false;
      }
    });

    // =======================
    // Listen for Figma Messages
    // =======================
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === 'done') {
        if (currentMode === 'paste') {
          pasteStatusArea.innerHTML = '<div class="status success">Frames created!</div>';
          generateFromJsonBtn.disabled = false;
        } else {
          showStatus('Frames created successfully!', 'success');
          document.getElementById('submitBtn').disabled = false;
        }
      } else if (msg.type === 'error') {
        if (currentMode === 'paste') {
          pasteStatusArea.innerHTML = '<div class="status error">Error: ' + msg.message + '</div>';
          generateFromJsonBtn.disabled = false;
        } else {
          showStatus(`Error: ${msg.message}`, 'error');
          document.getElementById('submitBtn').disabled = false;
        }
      }
    };

    // =======================
    // Load Example Data
    // =======================
    function loadExample() {
      const example = {
        projectName: 'Good Manual',
        oneSentence: 'Mobile app for aeronautical technicians that digitizes maintenance manuals',
        productType: 'App',
        primaryPlatforms: ['Mobile', 'Tablet'],
        realWorldSituation: 'Aeronautical technicians in hangars consult physical manuals of 500+ pages during inspections',
        whatGoesWrong: 'Wasted time looking for procedures, errors due to outdated info',
        currentWorkarounds: 'PDFs on tablet, photos of pages, paper notes',
        userRoleContext: 'Aeronautic maintenance technicians with 5-15 years of experience',
        tryingToAccomplish: 'Complete inspections quickly, safely, and documented',
        researchBacking: ['User interviews'],
        researchBackingDetails: 'Interviews with 12 technicians, average 45 min looking for info per shift',
        desiredOutcome: 'Reduce search time from 45 min to 5 min per shift',
        whyUseThis: 'Immediate access to procedures with smart search',
        productGoals: '- Reduce search time by 90%\n- Eliminate outdated info errors\n- Improve traceability',
        mustHaveFeatures: '- Voice search\n- Offline mode\n- Update alerts\n- Digital checklist',
        niceToHave: '- Augmented reality\n- Real-time collaboration',
        outOfScope: '- Inventory management\n- Billing',
        technicalPlatformConstraints: 'iOS/Android, work offline, sync with existing system',
        businessTimelineConstraints: 'MVP in 4 months, limited budget, team of 3',
        adoptionRisks: 'Resistance from senior techs, connectivity dependency',
        keyMetrics: 'Search time: 45min -> 5min\nAdoption: 80% in 6 months\nErrors: -50%',
        facts: 'Average 45 min/shift looking for info (measured in 3 hangars)',
        assumptions: 'Techs prefer digital if it is faster than paper',
        needsValidation: 'Usability with gloves, offline performance',
        ageOccupation: '35-55, Aeronautic maintenance technician',
        techProficiency: 'Comfortable',
        mainMotivations: 'Safety, efficiency, precision',
        dailyRoutineSnapshot: 'Arrives at 6am, checks assigned tasks, inspects aircraft, documents findings',
        numStages: '3',
        opportunityAreas: 'Predictive search, integration with airline systems'
      };

      Object.entries(example).forEach(([key, value]) => {
        if (Array.isArray(value)) {
          value.forEach(v => {
            const checkbox = form.querySelector(`[name="${key}"][value="${v}"]`);
            if (checkbox) checkbox.checked = true;
          });
        } else {
          const input = form.querySelector(`[name="${key}"]`);
          if (input) input.value = value;
        }
      });

      renderStages();

      form.querySelector('[name="stage1Name"]').value = 'Preparation';
      form.querySelector('[name="stage1Action"]').value = 'Reviews assigned tasks and gathers tools';
      form.querySelector('[name="stage2Name"]').value = 'Inspection';
      form.querySelector('[name="stage2Action"]').value = 'Executes procedures consulting manual';
      form.querySelector('[name="stage3Name"]').value = 'Documentation';
      form.querySelector('[name="stage3Action"]').value = 'Records findings and signs completed';

      updateProgress();
    }

    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'e') {
        e.preventDefault();
        loadExample();
      }
    });

    // Initialize
    updatePhaseDisplay('definition');
    updateProgress();
  </script>
</body>
</html>
